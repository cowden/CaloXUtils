
Running the Geant4 simulation
-----------------------------
The Geant4 simulation needs a few environment variables to be set in
order to control the run and output.

export CaloXG4OutName="XXXXXYYYYY/sampl_Si_0p5_XXXXXYYYYY_ZZZZZ.root"  # output root tree file name.
export CaloXG4RunNumber=1   # run number
export CaloXG4EventNumber=1 # initial event number
export CaloXG4SeedA=1       # 0=default (fixed), 1 auto, >1 manual seed setting
export CaloXG4SeedB=2019    # second seed for manual seed setting (CaloXG4SeedA>1)
export CaloXG4SaveSeeds=1   # 0=not save,  1=save seeds. 

export CaloXG4map1CellEdepON=1 # Hit Map 0=off, 1=on
export CaloXG4map2PidEdepON=1  # Edep per particle (Pid) 0=off, 1=on
export CaloXG4mapTcutMin=0       # time cut on Map creation (minimum)  (psec)  
export CaloXG4mapTcutMax=100000  # time cut on Map creation (maximum) (psec)  
export CaloXG4map1CelEcutMinSave=10 # energy cut on Edep per cell during tree output (kev).

Build Copula Model and Draw Samples
-----------------------------------
The `genMisCalibration_v1.r` R script constructs a vine model, via the
`VineCopula` package, to model the correlation of mis-calibration
factors and noise of a detector (test-beam module).  For our test beam
module (75x50x50), the correlation matrix is too large to be accessed by
32 bit integers, which may be a limitation in R.  There are also memory
constraints when building large vine models.  This script draws
miscalibration factors from an assembly of panels to cover the entire
module.  It makes an implicit assumption of independence outside of
panels.  

Panels are made to cover, with some overlap, the entire detector module.
Enough draws are made to give many, independent complete module
representative samples of the detector module.  It is assumed that later
scripts slice the panels to cover the detector module in a
non-overlapping manor.  See the `calib.cfg` file for the settings of
this script.

prep_sim_for_cnn.py
-------------------
This script replaces what was performed by the
`readT_HitsOp6MeV_sampl_Si.py` and `rewriteNPZ.py` into a single script.
The `prep_sim_for_cnn.py` script extracts the G4 simulation data
generated from the CaloX_G4 produced ROOT file and writes a compressed
set of numpy arrays to for consumption by the CNN model.

calib_prep.py
-------------
The `calib_prep.py` script assembles a random set of panel draws to
model detector module miscalibration.  Marginal distributions are
generated by a beta distribution with parameters `alpha` and `beta`.
The miscalibration factor distribution is centered to 1.
Noise is also drawn with the assembled miscalibration correlation
structure and same beta distribution.  The noise distribution is
centered at zero and scaled.

The CNN predicts energy where each batch is adjusted by the
multiplicative miscalibration factor and additive noise terms.
